{% extends 'base.html.twig' %}

{% block title %}
	{{ isSeries ? item.name : item.title }}
{% endblock %}

{% block body %}
	<div class="container my-5">

		<div class="body-content">
			<h3 class="title-show text-center my-4">
				{{ isSeries ? item.name : item.title }}
				({{ (isSeries and item.first_air_date ? item.first_air_date : item.release_date)|date('Y') }})
			</h3>

			<div class="container-fluid">
				<div class="row">
					<div class="col-md-4">
						<div class="position-relative">
							{% if item.poster_path %}
								<img class="movie-poster img-fluid rounded" src="https://image.tmdb.org/t/p/w500{{ item.poster_path }}" alt="Poster de {{ isSeries ? item.name : item.title }}">
							{% else %}
								<img class="movie-poster img-fluid rounded" src="https://placehold.co/500x750/222/FFF?text=Pas+d'affiche" alt="Pas d'affiche disponible">
							{% endif %}

							{# Note du film/série #}
							{% if item.vote_average is defined and item.vote_average > 0 %}
								<div class="content-rating">
									{{ item.vote_average|round(1, 'floor') }}
								</div>
							{% endif %}

							{# ⭐ ÉTOILE FAVORITE ET SIGNET (Ajout) #}
							{% if app.user %}
								{% set isFavorite = false %}
								{% set inLists = [] %}

								{% if app.user.movieLists is not empty %}
									{% for list in app.user.movieLists %}
										{% for listItem in list.movieListItems %}
											{% if listItem.tmdbId == item.id and listItem.tmdbType == (isSeries ? 'tv' : 'movie') %}
												{% set inLists = inLists|merge([list.name]) %}
												{% if list.name == 'Favoris' %}
													{% set isFavorite = true %}
												{% endif %}
											{% endif %}
										{% endfor %}
									{% endfor %}
								{% endif %}

								{# Signet en haut à GAUCHE #}
								<button class="in-lists-badge {{ inLists is not empty ? 'has-lists' : '' }}" data-controller="bookmark" data-bookmark-tmdb-id-value="{{ item.id }}" data-bookmark-tmdb-type-value="{{ isSeries ? 'tv' : 'movie' }}" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-html="true" title="{{ inLists is not empty ? '<strong>Dans vos listes :</strong><br>' ~ inLists|join('<br>') : 'Pas encore dans vos listes' }}" type="button" disabled>
									<i class="fas fa-bookmark"></i>
								</button>

								{# Étoile en haut à DROITE pour les favoris #}
								<button class="favorite-star {{ isFavorite ? 'is-favorite' : '' }}" data-tmdb-id="{{ item.id }}" data-tmdb-type="{{ isSeries ? 'tv' : 'movie' }}" data-controller="favorite" data-action="click->favorite#toggle" aria-label="Ajouter aux favoris" title="{{ isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris' }}" type="button">
									<i class="fas fa-star"></i>
								</button>
							{% endif %}
						</div>

						{# --- BLOC PAYS ET BUDGET --- #}
						<div
							class="mt-3">
							{# Pays d'origine #}
							{% if not isSeries and item.production_countries is not empty %}
								<p class="mb-1">
									<strong class="info">Pays d'origine :</strong>
									{{ item.production_countries|map(c => c.name)|join(', ') }}
								</p>
							{% elseif isSeries and item.origin_country is not empty %}
								<p class="mb-1">
									<strong class="info">Pays d'origine :</strong>
									{{ item.origin_country|join(', ') }}
								</p>
							{% endif %}

							{# Budget (uniquement pour les films) #}
							{% if not isSeries and item.budget is defined and item.budget > 0 %}
								<p class="mb-1">
									<strong class="info">Budget :</strong>
									{{ item.budget|number_format(0, '.', ' ') }}
									€
								</p>
							{% endif %}
						</div>

						{# --- BOUTON AJOUTER À UNE LISTE --- #}
{# Extrait du template content.html.twig - SECTION DROPDOWN #}

{# --- BOUTON AJOUTER À UNE LISTE --- #}
	{% if app.user %}
		<div class="dropdown mt-4" data-controller="add-to-list" data-add-to-list-tmdb-id-value="{{ item.id }}" data-add-to-list-tmdb-type-value="{{ isSeries ? 'tv' : 'movie' }}"> <button class="btn btn-primary dropdown-toggle w-100 btn-lg" type="button" id="dropdownMenuButton-{{ item.id }}" data-bs-toggle="dropdown" aria-expanded="false">
			<i class="fas fa-plus"></i>
			Ajouter à une liste
		</button>

		<ul class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton-{{ item.id }}">
			{% if app.user.movieLists is not empty %}
				{% for list in app.user.movieLists %}
					<li>
						<a class="dropdown-item" href="{{ path('app_movie_list_add_item', {'id': list.id, 'tmdbId': item.id, 'tmdbType': isSeries ? 'tv' : 'movie'}) }}" data-action="click->add-to-list#add">
							<i class="fas fa-list me-2"></i>
							{{ list.name }}
						</a>
					</li>
				{% endfor %}
			{% else %}
				<li>
					<span class="dropdown-item disabled">
						<i class="fas fa-info-circle me-2"></i>Créez d'abord une liste
					</span>
				</li>
			{% endif %}
		</ul>
	</div>
{% endif %}

					</div>

					<div class="col-md-8">
						<div
							class="row mb-4">

							{# --- RÉALISATEUR + BANDE-ANNONCE CÔTE À CÔTE --- #}
							<div class="col-12 mb-4">
								<div
									class="row align-items-start">

									{# Colonne réalisateur(s) #}
									<div class="col-md-6 mb-3">
										{% set directors = [] %}
										{% if item.credits.crew is defined %}
											{% for member in item.credits.crew %}
												{% if member.job == 'Director' %}
													{% set directors = directors|merge([member.name]) %}
												{% endif %}
											{% endfor %}
										{% endif %}

										{% if directors is not empty %}
											<h4 class="director d-inline-block px-2 rounded mb-0">Réalisateur(s) :</h4>
											<p class="real mt-2">{{ directors|join(', ') }}</p>
										{% else %}
											<h4 class="director d-inline-block px-2 rounded mb-0">Réalisateur :</h4>
											<p class="real mt-2">Inconnu</p>
										{% endif %}
									</div>

									{# Colonne bande-annonce #}
									<div class="col-md-6">
										{% set trailer = null %}
										{% if item.videos.results is defined %}
											{% for video in item.videos.results %}
												{% if trailer is null and video.type == 'Trailer' and video.site == 'YouTube' %}
													{% set trailer = video %}
												{% endif %}
											{% endfor %}
										{% endif %}

										{% if trailer %}
											<h4 class="director d-inline-block px-2 rounded mb-0">Bande-annonce :</h4>
											<div class="ratio ratio-16x9 mt-2">
												<iframe src="https://www.youtube.com/embed/{{ trailer.key }}?autoplay=1&mute=1&loop=1&playlist={{ trailer.key }}" title="Bande-annonce" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
											</div>
										{% else %}
											<p class="text-muted mt-2">Pas de bande-annonce disponible.</p>
										{% endif %}
									</div>

								</div>
							</div>

							{# --- BLOC ACTEURS PRINCIPAUX --- #}
							<div class="col-12">
								<h4 class="director d-inline-block px-2 rounded">Acteurs principaux :</h4>
							</div>

							<div class="row">
								{% for actor in item.credits.cast|slice(0, 4) %}
									<div class="stars col-6 col-md-3 text-center h-100 d-flex flex-column">
										{% if actor.profile_path %}
											<img class="image-stars rounded-circle img-fluid mb-2" src="https://image.tmdb.org/t/p/w200{{ actor.profile_path }}" alt="Photo de {{ actor.name }}">
										{% else %}
											<img class="image-stars rounded-circle img-fluid mb-2" src="https://placehold.co/200x300/222/FFF?text={{ actor.name|url_encode }}" alt="Photo de {{ actor.name }} non disponible">
										{% endif %}
										<p class="actor-name mt-auto">
											{{ actor.name }}<br><em>({{ actor.character }})</em>
										</p>
									</div>
								{% endfor %}
							</div>

							{# --- BLOC SYNOPSIS --- #}
							<div class="col-12 mt-4">
								<h4 class="director d-inline-block px-2 rounded mb-3">Synopsis :</h4>
								<p class="description">{{ item.overview }}</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
