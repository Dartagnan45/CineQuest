{% extends 'base.html.twig' %}

{% block title %}
	{{ isSeries ? item.name : item.title }}
{% endblock %}

{% block body %}

	{# --- FANART EN FOND --- #}
	{% set fanart = (item.backdrop_path is defined and item.backdrop_path) ? 'https://image.tmdb.org/t/p/original' ~ item.backdrop_path : null %}

	<div class="wtw-fanart-wrapper" style="{% if fanart %}--fanart:url('{{ fanart }}');{% endif %}">

		<div class="container my-5">

			<div class="body-content bg-dark bg-opacity-75 p-4 rounded shadow-lg">
				<h3 class="title-show text-center my-4 text-white">
					{{ isSeries ? item.name : item.title }}
					({{ (isSeries and item.first_air_date ? item.first_air_date : item.release_date)|date('Y') }})
				</h3>

				<div class="container-fluid">
					<div class="row">
						<div
							class="col-md-4">
							{# --- POSTER SIMPLE (zoomable) --- #}
							<div class="poster-container position-relative">
								{% if item.poster_path %}
									<img class="movie-poster img-fluid rounded" src="https://image.tmdb.org/t/p/w500{{ item.poster_path }}" alt="Poster de {{ isSeries ? item.name : item.title }}" data-action="click->poster-lightbox#open" data-controller="poster-lightbox" data-poster-lightbox-url-value="https://image.tmdb.org/t/p/original{{ item.poster_path }}" style="cursor: pointer;">
								{% else %}
									<img class="movie-poster img-fluid rounded" src="https://placehold.co/500x750/222/FFF?text=Pas+d'affiche" alt="Pas d'affiche disponible">
								{% endif %}

								{# Note TMDb #}
								{% if item.vote_average is defined and item.vote_average > 0 %}
									<div class="content-rating">
										{{ item.vote_average|round(1, 'floor') }}
									</div>
								{% endif %}

								{# Boutons favoris / signets #}
								{% if app.user %}
									{% set isFavorite = false %}
									{% set inLists = [] %}

									{% if app.user.movieLists is not empty %}
										{% for list in app.user.movieLists %}
											{% for listItem in list.movieListItems %}
												{% if listItem.tmdbId == item.id and listItem.tmdbType == (isSeries ? 'tv' : 'movie') %}
													{% set inLists = inLists|merge([list.name]) %}
													{% if list.name == 'Favoris' %}
														{% set isFavorite = true %}
													{% endif %}
												{% endif %}
											{% endfor %}
										{% endfor %}
									{% endif %}

									<button class="in-lists-badge {{ inLists is not empty ? 'has-lists' : '' }}" data-controller="bookmark" data-bookmark-tmdb-id-value="{{ item.id }}" data-bookmark-tmdb-type-value="{{ isSeries ? 'tv' : 'movie' }}" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-html="true" title="{{ inLists is not empty ? '<strong>Dans vos listes :</strong><br>' ~ inLists|join('<br>') : 'Pas encore dans vos listes' }}" type="button" disabled>
										<i class="fas fa-bookmark"></i>
									</button>

									<button class="favorite-star {{ isFavorite ? 'is-favorite' : '' }}" data-tmdb-id="{{ item.id }}" data-tmdb-type="{{ isSeries ? 'tv' : 'movie' }}" data-controller="favorite" data-action="click->favorite#toggle" aria-label="Ajouter aux favoris" title="{{ isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris' }}" type="button">
										<i class="fas fa-star"></i>
									</button>
								{% endif %}
							</div>

							{# Lightbox pour zoom #}
							<div id="posterLightbox" class="poster-lightbox" data-controller="poster-lightbox" data-action="click->poster-lightbox#close">
								<span class="lightbox-close" data-action="click->poster-lightbox#close">&times;</span>
								<img class="lightbox-content" id="lightboxImage" alt="">
							</div>

							{# --- PAYS / BUDGET --- #}
							<div class="mt-3 text-white">
								{% if not isSeries and item.production_countries is not empty %}
									{% set countryNames = [] %}
									{% for c in item.production_countries %}
										{% if c.name is defined %}
											{% set countryNames = countryNames|merge([c.name]) %}
										{% endif %}
									{% endfor %}
									{% if countryNames is not empty %}
										<p class="mb-1">
											<strong>Pays d'origine :</strong>
											{{ countryNames|join(', ') }}</p>
									{% endif %}
								{% elseif isSeries and item.origin_country is not empty %}
									<p class="mb-1">
										<strong>Pays d'origine :</strong>
										{{ item.origin_country|join(', ') }}</p>
								{% endif %}

								{% if not isSeries and item.budget is defined and item.budget > 0 %}
									<p class="mb-1">
										<strong>Budget :</strong>
										{{ item.budget|number_format(0, '.', ' ') }}
										€</p>
								{% endif %}

								{# --- NOTES TMDB + IMDb + RT + Metacritic --- #}
								<div class="mt-3 ratings-section">
									<h5 class="mb-3">
										<strong>
											<i class="fas fa-star text-warning me-1"></i>Notes</strong>
									</h5>

									<div
										class="ratings-container">
										{# TMDb #}
										{% if item.vote_average is defined and item.vote_average > 0 %}
											{% set tmdbPercent = (item.vote_average * 10)|round(0) %}
											<div class="rating-item mb-3">
												<a href="{{ links.tmdb }}" target="_blank" rel="noopener noreferrer" class="rating-logo-link" title="Voir sur TMDb">
													<div class="rating-logo-wrapper tmdb-logo-bg">
														<img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_short-8e7b30f73a4020692ccca9c88bafe5dcb6f8a62a4c6bc55cd9ba82bb2cd95f6c.svg" alt="TMDb" class="rating-logo-img">
													</div>
												</a>
												<div class="rating-details">
													<div class="rating-score tmdb-score">
														<span class="score-number">{{ tmdbPercent }}%</span>
													</div>
													{% if item.vote_count is defined and item.vote_count > 0 %}
														<div class="rating-votes">{{ item.vote_count|number_format(0, '.', ' ') }}
															votes</div>
													{% endif %}
												</div>
											</div>
										{% endif %}

										{# IMDb #}
										{% if omdb is defined and omdb is not null %}
											{% set imdbRating = omdb.imdbRating ?? null %}
											{% if imdbRating and imdbRating != 'N/A' and links.imdb %}
												<div class="rating-item mb-3">
													<a href="{{ links.imdb }}" target="_blank" rel="noopener noreferrer" class="rating-logo-link" title="Voir sur IMDb">
														<div class="rating-logo-wrapper imdb-logo-bg">
															<img src="https://upload.wikimedia.org/wikipedia/commons/6/69/IMDB_Logo_2016.svg" alt="IMDb" class="rating-logo-img imdb-logo-img">
														</div>
													</a>
													<div class="rating-details">
														<div class="rating-score imdb-score">
															<span class="score-number">{{ imdbRating }}/10</span>
														</div>
														{% if omdb.imdbVotes is defined and omdb.imdbVotes != 'N/A' %}
															<div class="rating-votes">{{ omdb.imdbVotes }}
																votes</div>
														{% endif %}
													</div>
												</div>
											{% endif %}

											{# Rotten Tomatoes #}
											{% set rtScore = omdb.RottenTomatoesScore ?? null %}
											{% if rtScore and rtScore != 'N/A' and links.rotten_tomatoes %}
												<div class="rating-item mb-3">
													<a href="{{ links.rotten_tomatoes }}" target="_blank" rel="noopener noreferrer" class="rating-logo-link" title="Voir sur Rotten Tomatoes">
														<div class="rating-logo-wrapper rt-logo-bg">
															<img src="{{ asset('build/images/ratings/rotten-tomatoes.png') }}" alt="Rotten Tomatoes" class="rating-logo-img rt-logo-img">
														</div>
													</a>
													<div class="rating-details">
														<div class="rating-score rt-score">
															<span class="score-number">{{ rtScore }}</span>
														</div>
														<div class="rating-votes">Tomatometer</div>
													</div>
												</div>
											{% endif %}

											{# Metacritic #}
											{% set metacriticScore = omdb.MetacriticScore ?? null %}
											{% if metacriticScore and metacriticScore != 'N/A' and links.metacritic %}
												<div class="rating-item mb-3">
													<a href="{{ links.metacritic }}" target="_blank" rel="noopener noreferrer" class="rating-logo-link" title="Voir sur Metacritic">
														<div class="rating-logo-wrapper metacritic-logo-bg">
															<img src="{{ asset('build/images/ratings/metacritic.png') }}" alt="Metacritic" class="rating-logo-img metacritic-logo-img">
														</div>
													</a>
													<div class="rating-details">
														<div class="rating-score metacritic-score">
															<span class="score-number">{{ metacriticScore }}</span>
														</div>
														<div class="rating-votes">Metascore</div>
													</div>
												</div>
											{% endif %}
										{% endif %}
									</div>
								</div>

								{# --- PLATEFORMES EN DESSOUS DES NOTES --- #}
								{% if watchProviders.flatrate is not empty or watchProviders.rent is not empty or watchProviders.buy is not empty %}
									<div class="mt-4">
										<h4 class="director d-inline-block px-2 rounded mb-3">Disponible sur</h4>

										{% if watchProviders.flatrate is not empty %}
											<div class="mb-3">
												<p class="mb-2 small text-muted fw-bold">
													<i class="fas fa-play-circle me-1"></i>STREAMING</p>
												<div class="d-flex flex-wrap gap-2">
													{% for provider in watchProviders.flatrate %}
														<div class="watch-provider-item" data-bs-toggle="tooltip" title="{{ provider.provider_name }}">
															<img src="https://image.tmdb.org/t/p/original{{ provider.logo_path }}" alt="{{ provider.provider_name }}" class="rounded">
														</div>
													{% endfor %}
												</div>
											</div>
										{% endif %}

										{% if watchProviders.rent is not empty %}
											<div class="mb-3">
												<p class="mb-2 small text-muted fw-bold">
													<i class="fas fa-shopping-cart me-1"></i>LOCATION</p>
												<div class="d-flex flex-wrap gap-2">
													{% for provider in watchProviders.rent %}
														<div class="watch-provider-item" data-bs-toggle="tooltip" title="{{ provider.provider_name }}">
															<img src="https://image.tmdb.org/t/p/original{{ provider.logo_path }}" alt="{{ provider.provider_name }}" class="rounded">
														</div>
													{% endfor %}
												</div>
											</div>
										{% endif %}

										{% if watchProviders.buy is not empty %}
											<div class="mb-3">
												<p class="mb-2 small text-muted fw-bold">
													<i class="fas fa-dollar-sign me-1"></i>ACHAT</p>
												<div class="d-flex flex-wrap gap-2">
													{% for provider in watchProviders.buy %}
														<div class="watch-provider-item" data-bs-toggle="tooltip" title="{{ provider.provider_name }}">
															<img src="https://image.tmdb.org/t/p/original{{ provider.logo_path }}" alt="{{ provider.provider_name }}" class="rounded">
														</div>
													{% endfor %}
												</div>
											</div>
										{% endif %}
									</div>
								{% else %}
									<div class="mt-4">
										<p class="text-muted small fst-italic">
											<i class="fas fa-info-circle me-1"></i>Aucune plateforme disponible en France pour le moment.
										</p>
									</div>
								{% endif %}
							</div>

							{# --- AJOUT À UNE LISTE --- #}
							{% if app.user %}
								<div class="dropdown mt-4" data-controller="add-to-list" data-add-to-list-tmdb-id-value="{{ item.id }}" data-add-to-list-tmdb-type-value="{{ isSeries ? 'tv' : 'movie' }}">
									<button class="btn btn-primary dropdown-toggle w-100 btn-lg" type="button" id="dropdownMenuButton-{{ item.id }}" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="fas fa-plus"></i>
										Ajouter à une liste
									</button>
									<ul class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton-{{ item.id }}">
										{% if app.user.movieLists is not empty %}
											{% for list in app.user.movieLists %}
												<li>
													<a class="dropdown-item" href="{{ path('app_movie_list_add_item', {'id': list.id, 'tmdbId': item.id, 'tmdbType': isSeries ? 'tv' : 'movie'}) }}" data-action="click->add-to-list#add">
														<i class="fas fa-list me-2"></i>
														{{ list.name }}
													</a>
												</li>
											{% endfor %}
										{% else %}
											<li>
												<span class="dropdown-item disabled">
													<i class="fas fa-info-circle me-2"></i>Créez d'abord une liste</span>
											</li>
										{% endif %}
									</ul>
								</div>
							{% endif %}
						</div>

						{# --- SECTION DE DROITE (TRAILER, ACTEURS, SYNOPSIS) --- #}
						<div class="col-md-8 text-white">
							<div
								class="row mb-4">

								{# Réalisateur #}
								<div class="col-md-12 mb-4">
									{% set director = null %}
									{% if item.credits.crew is defined %}
										{% for member in item.credits.crew %}
											{% if member.job == 'Director' and director is null %}
												{% set director = member %}
											{% endif %}
										{% endfor %}
									{% endif %}

									<h4 class="director d-inline-block px-2 rounded mb-3">Réalisateur :</h4>
									{% if director %}
										<a href="{{ path('person_details', {'id': director.id}) }}" class="director-card text-decoration-none">
											<div class="d-flex align-items-center mb-3 p-2 rounded director-hover">
												{% if director.profile_path %}
													<img src="https://image.tmdb.org/t/p/w185{{ director.profile_path }}" alt="Photo de {{ director.name }}" class="director-photo rounded-circle me-3">
												{% else %}
													<div class="director-photo-placeholder rounded-circle me-3 d-flex align-items-center justify-content-center">
														<i class="fas fa-user fa-2x text-muted"></i>
													</div>
												{% endif %}
												<div>
													<p class="mb-0 fw-bold text-white">{{ director.name }}</p>
													<small class="text-muted">Voir la filmographie
														<i class="fas fa-arrow-right"></i>
													</small>
												</div>
											</div>
										</a>
									{% else %}
										<p class="real mt-2">Inconnu</p>
									{% endif %}
								</div>

								{# Trailer YouTube #}
								<div class="col-md-12 mb-4">
									{% set trailer = null %}
									{% if item.videos.results is defined %}
										{% for video in item.videos.results %}
											{% if trailer is null and video.type == 'Trailer' and video.site == 'YouTube' %}
												{% set trailer = video %}
											{% endif %}
										{% endfor %}
									{% endif %}

									{% if trailer %}
										<h4 class="director d-inline-block px-2 rounded mb-0">Bande-annonce :</h4>
										<div class="ratio ratio-16x9 mt-2">
											<iframe src="https://www.youtube.com/embed/{{ trailer.key }}?autoplay=1&mute=1&loop=1&playlist={{ trailer.key }}" title="Bande-annonce" allowfullscreen></iframe>
										</div>
									{% else %}
										<p class="text-muted mt-2">Pas de bande-annonce disponible.</p>
									{% endif %}
								</div>

								{# Acteurs #}
								<div class="col-12">
									<h4 class="director d-inline-block px-2 rounded">Acteurs principaux :</h4>
								</div>

								<div class="row">
									{% for actor in (item.credits.cast is defined ? item.credits.cast|slice(0, 4) : []) %}
										<div class="stars col-6 col-md-3 text-center d-flex flex-column mb-3">
											<a href="{{ path('person_details', {'id': actor.id}) }}" class="text-decoration-none">
												{% if actor.profile_path %}
													<img class="image-stars rounded-circle img-fluid mb-2 actor-hover" src="https://image.tmdb.org/t/p/w200{{ actor.profile_path }}" alt="Photo de {{ actor.name }}">
												{% else %}
													<img class="image-stars rounded-circle img-fluid mb-2 actor-hover" src="https://placehold.co/200x300/222/FFF?text={{ actor.name|url_encode }}" alt="Photo de {{ actor.name }} non disponible">
												{% endif %}
												<p class="actor-name mt-auto text-white">{{ actor.name }}<br><em class="text-muted">({{ actor.character }})</em>
												</p>
											</a>
										</div>
									{% endfor %}
								</div>

								{# Synopsis #}
								<div class="col-12 mt-4">
									<h4 class="director d-inline-block px-2 rounded mb-3">Synopsis :</h4>
									<p class="description">{{ item.overview }}</p>
								</div>

							</div>
						</div>

					</div>
				</div>

			</div>
		</div>

	</div>

{% endblock %}
