{% extends 'base.html.twig' %}

{% block title %}
	{{ movie_list.name }}
	- Mes Listes
{% endblock %}

{% block body %}
	<div class="container my-5 user-movie-list">

		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1 class="main-title">{{ movie_list.name }}</h1>

			<div class="btn-group" role="group">
				<a href="{{ path('app_movie_list_index') }}" class="btn btn-secondary">
					<i class="fas fa-arrow-left"></i>
					Retour aux listes
				</a>

				{% if not movie_list.isSystem %}
					<a href="{{ path('app_movie_list_edit', {'id': movie_list.id}) }}" class="btn btn-primary">
						<i class="fas fa-edit"></i>
						Modifier
					</a>

					{# Bouton de suppression de la liste #}
					<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteListModal">
						<i class="fas fa-trash"></i>
						Supprimer
					</button>
				{% endif %}
			</div>
		</div>

		{% if movie_list.description %}
			<p class="lead mb-4">{{ movie_list.description }}</p>
		{% endif %}

		<p class="text-light mb-4">
			<i class="fas fa-calendar"></i>
			Créée le
			{{ movie_list.createdAt|date('d/m/Y') }}
			{% if items|length > 0 %}
				•
				<i class="fas fa-film"></i>
				{{ items|length }}
				élément{{ items|length > 1 ? 's' : '' }}
			{% endif %}
		</p>

		{% if items_with_data is not empty %}
			<div class="movie-card-list mt-4">
				{% for item_data in items_with_data %}
					{% set entity = item_data.entity %}
					{% set data = item_data.data %}
					{% set isSeries = entity.tmdbType == 'tv' %}

					<div class="card">

						{% set item_path = isSeries ? path('tv_content', {'id': entity.tmdbId}) : path('movie_content', {'id': entity.tmdbId}) %}

						<a href="{{ item_path }}" class="text-decoration-none">
							<div class="card-img-top-wrapper">
								<img src="{{ data.poster_path ? 'https://image.tmdb.org/t/p/w500' ~ data.poster_path : asset('build/images/cine-room.jpeg') }}" class="card-img-top" alt="{{ isSeries ? data.name : data.title }}" loading="lazy">
							</div>
						</a>
						{# ... juste après l'image de la carte #}
						{% include 'partials/badges.html.twig' with { badges: data.badges|default([]) } %}


						{# Bouton de suppression de l'item #}
						<div class="card-remove-btn">
							<form method="post" action="{{ path('app_movie_list_delete_item', {'id': entity.id}) }}" class="d-inline">
								<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ entity.id) }}">
								<button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Retirer cet élément de la liste ?')">
									<i class="fas fa-times"></i>
								</button>
							</form>
						</div>

						<div class="card-body">
							{% if data.vote_average > 0 %}
								<div class="movie-rating">
									{{ (data.vote_average * 10)|round }}%
								</div>
							{% endif %}

							<p class="card-text text-muted small">
								{% if isSeries %}
									Sortie :
									{{ data.first_air_date ? data.first_air_date|date('Y') : 'Date inconnue' }}
								{% else %}
									Sortie :
									{{ data.release_date ? data.release_date|date('Y') : 'Date inconnue' }}
								{% endif %}
							</p>
							<h5 class="card-title">{{ isSeries ? data.name : data.title }}</h5>
							<p class="card-text">
								{{ data.overview|slice(0, 120) ~ (data.overview|length > 120 ? '...' : '') }}
							</p>

							<p class="card-text text-muted small">
								<i class="fas fa-plus-circle"></i>
								Ajouté le
								{{ entity.addedAt|date('d/m/Y') }}
							</p>
						</div>
					</div>
				{% endfor %}
			</div>
		{% else %}
			<div class="alert alert-info mt-4">
				<i class="fas fa-info-circle"></i>
				Cette liste est vide. Commencez à ajouter des films et séries !
			</div>

			<div class="text-center mt-4">
				<a href="{{ path('app_what_to_watch_selection') }}" class="btn btn-primary btn-lg">
					<i class="fas fa-search"></i>
					Découvrir du contenu
				</a>
			</div>
		{% endif %}
	</div>

	{# Modal de confirmation de suppression de la liste #}
	{% if not movie_list.isSystem %}
		<div class="modal fade" id="deleteListModal" tabindex="-1" aria-labelledby="deleteListModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="deleteListModalLabel">Confirmer la suppression</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						Êtes-vous sûr de vouloir supprimer la liste
						<strong>{{ movie_list.name }}</strong>
						?
																		Cette action est irréversible et supprimera tous les éléments de la liste.
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<form method="post" action="{{ path('app_movie_list_delete', {'id': movie_list.id}) }}" class="d-inline">
							<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ movie_list.id) }}">
							<button type="submit" class="btn btn-danger">
								<i class="fas fa-trash"></i>
								Supprimer définitivement
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	{% endif %}
{% endblock %}
